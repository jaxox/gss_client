<?xml version="1.0" encoding="UTF-8"?>
<story-context id="1-2-email-password-authentication" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1-2</storyId>
    <title>Email/Password Authentication</title>
    <status>ready-for-dev</status>
    <generatedAt>November 6, 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-2-email-password-authentication.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to register and log in using email and password</iWant>
    <soThat>I can access the platform securely without requiring social media accounts</soThat>
    <tasks>
      <task id="1" ac="AC1">
        <title>Build Registration UI Components</title>
        <subtasks>
          <item>Create RegistrationScreen component for mobile (mobile/src/screens/auth/RegistrationScreen.tsx)</item>
          <item>Create RegistrationPage component for web (web/src/pages/auth/RegistrationPage.tsx)</item>
          <item>Implement form fields: email (TextInput/TextField), password (secure TextInput/TextField), displayName, homeCity</item>
          <item>Add client-side validation with real-time feedback (email format, password strength indicator)</item>
          <item>Create shared validation utilities in shared/src/utils/validation.ts (validateEmail, validatePassword)</item>
          <item>Implement responsive layout following Material Design 3 (React Native Paper on mobile, MUI on web)</item>
          <item>Add loading states, disabled button states during submission</item>
          <item>Create password strength indicator component (weak/medium/strong visual feedback)</item>
        </subtasks>
      </task>
      <task id="2" ac="AC1">
        <title>Implement Registration Business Logic</title>
        <subtasks>
          <item>Create registerWithEmail method in AuthService (shared/src/services/api/auth.service.ts)</item>
          <item>Implement request payload construction from form inputs (RegisterRequest interface)</item>
          <item>Add API call to POST /api/auth/register using ky HTTP client</item>
          <item>Handle successful response: extract JWT tokens, store securely, update auth state</item>
          <item>Implement error handling with specific error codes (409 duplicate email, 400 validation, 500 server error)</item>
          <item>Create Redux action creators for registration flow (registerStart, registerSuccess, registerFailure)</item>
          <item>Write unit tests for registration service methods and Redux actions</item>
          <item>Write integration tests for complete registration flow with mock API</item>
        </subtasks>
      </task>
      <task id="3" ac="AC2">
        <title>Build Login UI Components</title>
        <subtasks>
          <item>Create LoginScreen component for mobile (mobile/src/screens/auth/LoginScreen.tsx)</item>
          <item>Create LoginPage component for web (web/src/pages/auth/LoginPage.tsx)</item>
          <item>Implement form fields: email (with autocomplete), password (secure with show/hide toggle)</item>
          <item>Add "Forgot password?" link navigating to password reset screen</item>
          <item>Create "Remember me" checkbox component with explanatory tooltip</item>
          <item>Implement form validation with real-time error display</item>
          <item>Add keyboard handling (submit on Enter key, tab navigation)</item>
          <item>Create loading spinner and disabled states during authentication</item>
        </subtasks>
      </task>
      <task id="4" ac="AC2,AC3">
        <title>Implement Login Business Logic</title>
        <subtasks>
          <item>Create loginWithEmail method in AuthService (shared/src/services/api/auth.service.ts)</item>
          <item>Implement request payload with email, password, and rememberMe flag</item>
          <item>Add API call to POST /api/auth/login using ky HTTP client</item>
          <item>Handle successful response: store JWT tokens with appropriate expiration based on rememberMe</item>
          <item>Implement secure token storage using StorageService (Keychain on iOS, Keystore on Android, secure browser storage on web)</item>
          <item>Update auth state in Redux store with user data and authentication status</item>
          <item>Implement error handling for 401 unauthorized, 404 user not found, network errors</item>
          <item>Create Redux action creators for login flow (loginStart, loginSuccess, loginFailure)</item>
          <item>Write unit tests for login service methods including rememberMe logic</item>
          <item>Write integration tests for login flow with various error scenarios</item>
        </subtasks>
      </task>
      <task id="5" ac="AC4">
        <title>Build Forgot Password UI Flow</title>
        <subtasks>
          <item>Create ForgotPasswordScreen component for mobile (mobile/src/screens/auth/ForgotPasswordScreen.tsx)</item>
          <item>Create ForgotPasswordPage component for web (web/src/pages/auth/ForgotPasswordPage.tsx)</item>
          <item>Implement email input field with validation</item>
          <item>Add submit button with loading state</item>
          <item>Create success confirmation screen/modal with clear messaging</item>
          <item>Create ResetPasswordScreen component for mobile (mobile/src/screens/auth/ResetPasswordScreen.tsx)</item>
          <item>Create ResetPasswordPage component for web (web/src/pages/auth/ResetPasswordPage.tsx)</item>
          <item>Implement new password and confirm password fields with validation</item>
          <item>Add password strength indicator to reset form</item>
          <item>Create success screen redirecting to login after 3 seconds</item>
        </subtasks>
      </task>
      <task id="6" ac="AC4">
        <title>Implement Forgot Password Business Logic</title>
        <subtasks>
          <item>Create forgotPassword method in AuthService (shared/src/services/api/auth.service.ts)</item>
          <item>Add API call to POST /api/auth/forgot-password with email</item>
          <item>Handle success and error responses with appropriate user messaging</item>
          <item>Create resetPassword method in AuthService</item>
          <item>Implement password reset token extraction from URL/deep link</item>
          <item>Add API call to POST /api/auth/reset-password with token and new password</item>
          <item>Implement token expiration handling (show error if token expired)</item>
          <item>Create Redux actions for forgot password and reset password flows</item>
          <item>Write unit tests for password reset service methods</item>
          <item>Write integration tests for complete forgot password flow including expired token scenarios</item>
        </subtasks>
      </task>
      <task id="7" ac="AC1,AC2,AC3,AC4">
        <title>Cross-Platform Integration &amp; Testing</title>
        <subtasks>
          <item>Test registration flow end-to-end on mobile (iOS simulator + Android emulator)</item>
          <item>Test registration flow end-to-end on web (Chrome, Safari, Firefox)</item>
          <item>Test login flow with "Remember me" enabled and disabled on all platforms</item>
          <item>Verify token storage persists across app restarts on mobile</item>
          <item>Verify token storage persists across browser refresh on web</item>
          <item>Test forgot password flow end-to-end including email link navigation</item>
          <item>Verify password reset token expiration handling</item>
          <item>Test form validation edge cases (special characters in email, Unicode in password)</item>
          <item>Test error handling for all API failure scenarios (network errors, server errors)</item>
          <item>Verify accessibility (screen reader support, keyboard navigation, focus management)</item>
          <item>Write E2E tests using Detox (mobile) and Playwright (web) for critical user journeys</item>
          <item>Verify performance: registration/login completion &lt;2s per NFR requirement</item>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>User Registration with Email/Password</title>
      <requirements>
        <item>Registration form displays email, password, display name, and home city input fields</item>
        <item>Client-side validation enforces email format, password strength (min 8 chars, 1 uppercase, 1 number, 1 special char)</item>
        <item>Form submission calls /api/auth/register endpoint with validated data</item>
        <item>Successful registration stores JWT tokens securely and navigates to main dashboard</item>
        <item>Error states display appropriate messages for validation failures and API errors (duplicate email, weak password, server errors)</item>
        <item>Registration form accessible and functional on both mobile and web platforms</item>
      </requirements>
    </criterion>
    <criterion id="AC2">
      <title>Email/Password Login Flow</title>
      <requirements>
        <item>Login form displays email and password input fields with "Forgot password?" link</item>
        <item>Form validation prevents submission with empty or invalid email format</item>
        <item>Login button calls /api/auth/login endpoint with credentials</item>
        <item>Successful login stores JWT tokens securely in platform-specific storage (Keychain/Keystore/Browser)</item>
        <item>Login navigates user to main dashboard after successful authentication</item>
        <item>Failed login displays clear error message (invalid credentials, account not found, server error)</item>
      </requirements>
    </criterion>
    <criterion id="AC3">
      <title>"Remember Me" Functionality</title>
      <requirements>
        <item>Login form includes optional "Remember me" checkbox</item>
        <item>When enabled, refresh token expiration extends to 90 days (from default 7 days)</item>
        <item>Token storage persists across app restarts when "Remember me" is enabled</item>
        <item>Unchecked "Remember me" uses default 7-day refresh token expiration</item>
        <item>User can toggle "Remember me" preference in app settings</item>
      </requirements>
    </criterion>
    <criterion id="AC4">
      <title>Forgot Password Flow</title>
      <requirements>
        <item>"Forgot password?" link on login screen navigates to password reset screen</item>
        <item>Password reset screen prompts for email address</item>
        <item>Form validates email format before submission</item>
        <item>Submission calls /api/auth/forgot-password endpoint</item>
        <item>Success displays confirmation message: "Password reset link sent to your email"</item>
        <item>Email contains secure reset link with time-limited token (expires in 1 hour)</item>
        <item>Reset link opens password reset form (new password + confirm password fields)</item>
        <item>New password submission calls /api/auth/reset-password with token and new password</item>
        <item>Successful reset redirects to login screen with success message</item>
      </requirements>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="AC2: User Registration System">
        Comprehensive technical specification covering user registration with email/password, including data models (User, AuthTokens, LoginRequest, RegisterRequest), API interfaces (IAuthService.register(), IAuthService.login()), workflows, security requirements (JWT token storage, HTTPS enforcement), and performance targets (authentication flow &lt;2s).
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="AC4: Email/Password Authentication">
        Details password management flows including forgotPassword(), resetPassword() methods, token expiration handling, and security considerations for password reset flows with single-use tokens expiring after 1 hour.
      </doc>
      <doc path="docs/architecture.md" title="Client Architecture Document" section="ADR-004: State Management">
        Defines Redux Toolkit + TanStack Query architecture for authentication state management, including async thunk patterns for API calls and integration with secure storage.
      </doc>
      <doc path="docs/architecture.md" title="Client Architecture Document" section="ADR-006: Design System">
        Specifies React Native Paper (mobile) and Material UI (web) component libraries for consistent cross-platform UI, including form components, validation patterns, and accessibility requirements.
      </doc>
      <doc path="docs/architecture.md" title="Client Architecture Document" section="Secure Storage">
        Details JWT token storage strategy using React Native Keychain (iOS), Android Keystore (Android), and encrypted browser storage (web) for secure credential management.
      </doc>
      <doc path="docs/shared/epics.md" title="Epics Breakdown" section="Epic 1">
        Platform Foundation &amp; Core Identity epic overview, including user stories for registration, authentication, and profile management with dependency chain: Story 1-1 (completed) → Story 1-2 (this story) → Story 1-3 (SSO).
      </doc>
      <doc path="docs/shared/PRD.md" title="Product Requirements Document" section="FR001: User Registration">
        Functional requirement specifying user registration with email + password and social auth options, display name collection, home city capture, and default avatar assignment.
      </doc>
      <doc path="docs/shared/PRD.md" title="Product Requirements Document" section="FR038: Security &amp; Auth">
        Security requirements for OAuth2/JWT authentication, refresh token management (15min access, 90day refresh with remember me), password reset flows, and HTTPS enforcement.
      </doc>
      <doc path="docs/stories/1-1-repository-structure-setup.md" title="Story 1-1: Repository Structure Setup" section="Learnings">
        Previous story context documenting monorepo structure establishment, shared TypeScript library creation with auth types and service interfaces, mock-first development pattern (MockAuthService), testing infrastructure setup (100% coverage), and reusable services/interfaces that MUST be extended (not recreated) in this story.
      </doc>
    </docs>
    <code>
      <artifact path="shared/src/types/auth.types.ts" kind="interface" symbol="User, AuthTokens, LoginRequest, RegisterRequest, AuthResponse">
        <reason>REUSE existing authentication type definitions from Story 1-1. Contains User interface with id, email, displayName, avatar, homeCity, reliabilityScore, level, xp fields. AuthTokens interface with accessToken, refreshToken, expiresAt. LoginRequest and RegisterRequest interfaces matching API contracts.</reason>
      </artifact>
      <artifact path="shared/src/types/api.types.ts" kind="interface" symbol="ApiResponse<T>, ApiError">
        <reason>REUSE existing API response wrappers for consistent error handling and response typing. Contains ApiResponse with data/success/message fields, ApiError with code/message/details/retryable fields.</reason>
      </artifact>
      <artifact path="shared/src/services/api/auth.service.ts" kind="interface" symbol="IAuthService">
        <reason>EXTEND existing auth service interface (currently abstract). Already defines login(), loginSSO(), register(), logout(), refreshToken(), getCurrentUser(), forgotPassword(), resetPassword(), getProfile(), updateProfile(), uploadAvatar() methods. Create concrete implementation (AuthServiceImpl) for real API calls using ky HTTP client.</reason>
      </artifact>
      <artifact path="shared/src/services/mock/mockAuth.service.ts" kind="service" symbol="MockAuthService">
        <reason>REUSE existing mock implementation for development without backend. Provides simulated authentication with 1s delays, predefined user accounts, and realistic error scenarios. Use during development before real backend integration.</reason>
      </artifact>
      <artifact path="shared/src/index.ts" kind="file" symbol="exports">
        <reason>EXTEND main export file to include new service implementations, validation utilities, and HTTP client configuration. Add exports for new shared modules created in this story.</reason>
      </artifact>
      <artifact path="mobile/src/screens/auth/" kind="directory" symbol="NEW">
        <reason>CREATE new authentication screens directory containing RegistrationScreen.tsx, LoginScreen.tsx, ForgotPasswordScreen.tsx, ResetPasswordScreen.tsx with React Native Paper components.</reason>
      </artifact>
      <artifact path="web/src/pages/auth/" kind="directory" symbol="NEW">
        <reason>CREATE new authentication pages directory containing RegistrationPage.tsx, LoginPage.tsx, ForgotPasswordPage.tsx, ResetPasswordPage.tsx with Material UI components.</reason>
      </artifact>
      <artifact path="shared/src/utils/validation.ts" kind="utility" symbol="NEW">
        <reason>CREATE validation utilities for form validation including validateEmail (regex pattern), validatePassword (strength requirements: min 8 chars, 1 uppercase, 1 number, 1 special char), and passwordStrength function returning weak/medium/strong.</reason>
      </artifact>
      <artifact path="shared/src/services/http/client.ts" kind="service" symbol="NEW">
        <reason>CREATE ky HTTP client configuration with base URL from environment variables, auth token interceptors for automatic JWT attachment, error interceptors for 401 handling and token refresh, timeout configuration (10s default).</reason>
      </artifact>
      <artifact path="mobile/src/store/auth/authSlice.ts" kind="redux" symbol="NEW">
        <reason>CREATE Redux Toolkit slice for authentication state management with reducers for registerStart/Success/Failure, loginStart/Success/Failure, logout, and async thunks for API calls. Integrate with SecureStorage for token persistence.</reason>
      </artifact>
      <artifact path="web/src/store/auth/authSlice.ts" kind="redux" symbol="NEW">
        <reason>CREATE Redux Toolkit slice for web authentication (similar structure to mobile but with browser-specific storage). Share business logic where possible through shared services.</reason>
      </artifact>
      <artifact path="shared/src/services/storage/secureStorage.ts" kind="service" symbol="NEW">
        <reason>CREATE secure storage abstraction for cross-platform token persistence. Mobile implementation uses React Native Keychain (iOS) and Android Keystore (Android). Web implementation uses encrypted browser storage. Provides storeTokens(), getTokens(), clearTokens() methods.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="ky" version="^1.7.2" scope="shared">HTTP client for API calls with interceptors and timeout support</package>
        <package name="zod" version="^3.23.8" scope="shared">Runtime validation and TypeScript schema validation for forms</package>
        <package name="@reduxjs/toolkit" version="^2.0.1" scope="mobile,web">State management foundation for authentication state</package>
        <package name="react-redux" version="^9.0.0" scope="mobile,web">React Redux bindings for connecting components to store</package>
        <package name="@tanstack/react-query" version="^5.0.0" scope="mobile,web">Server state management and caching for API data</package>
      </node>
      <mobile>
        <package name="react-native-paper" version="^5.12.3" scope="mobile">Material Design 3 component library for registration/login forms</package>
        <package name="react-native-keychain" version="^8.2.0" scope="mobile">Secure token storage for iOS (Keychain) and Android (Keystore)</package>
        <package name="react-navigation" version="^6.0.0" scope="mobile">Navigation framework for auth stack (login, register, forgot password flows)</package>
        <package name="react-native-vector-icons" version="^10.0.3" scope="mobile">Icon system for form UI (email icon, password visibility toggle)</package>
      </mobile>
      <web>
        <package name="@mui/material" version="^6.1.1" scope="web">Material Design components for web authentication forms</package>
        <package name="react-router-dom" version="^7.6.2" scope="web">Client-side routing for auth pages</package>
        <package name="@emotion/react" version="^11.13.3" scope="web">CSS-in-JS for component styling and theming</package>
      </web>
      <testing>
        <package name="jest" version="^29.7.0" scope="mobile,shared">Unit testing framework for service methods and Redux reducers</package>
        <package name="@testing-library/react-native" version="^13.3.3" scope="mobile">Component testing library for mobile screens</package>
        <package name="@testing-library/react" version="^16.1.0" scope="web">Component testing library for web pages</package>
        <package name="detox" version="^20.0.0" scope="mobile">E2E testing framework for mobile (iOS/Android)</package>
        <package name="@playwright/test" version="^1.48.2" scope="web">E2E testing framework for web browsers</package>
      </testing>
    </dependencies>
  </artifacts>

  <constraints>
    <security>
      <rule>ALL password fields must use secure TextInput (secureTextEntry on mobile, type="password" on web) to prevent shoulder surfing</rule>
      <rule>JWT tokens MUST be stored in platform-specific secure storage: React Native Keychain (iOS), Android Keystore (Android), encrypted browser storage (web). NEVER use AsyncStorage or localStorage for tokens</rule>
      <rule>Client-side password validation is for UX only - backend MUST enforce all security rules independently. Never trust client validation alone</rule>
      <rule>Forgot password tokens MUST be single-use and expire after 1 hour. Implement token expiration check before password reset form submission</rule>
      <rule>Implement rate limiting awareness in UI: disable submit button after 3 failed attempts, show cooldown message (30s-1min) to prevent brute force attacks</rule>
      <rule>All API communications MUST use HTTPS with certificate validation. Configure ky client to reject self-signed certificates in production</rule>
      <rule>Password strength requirements: minimum 8 characters, at least 1 uppercase letter, 1 number, 1 special character. Display real-time strength indicator (weak/medium/strong)</rule>
      <rule>Never log sensitive data: passwords, tokens, personal information. Use sanitized error messages for logging and analytics</rule>
    </security>
    <architecture>
      <rule>Follow monorepo workspace structure from Story 1-1: mobile/, web/, shared/ directories with proper separation of concerns</rule>
      <rule>REUSE existing types and interfaces from Story 1-1 - DO NOT create duplicate User or AuthTokens interfaces. Extend IAuthService interface if new methods needed</rule>
      <rule>Implement service abstraction pattern: Create AuthServiceImpl (real API) alongside existing MockAuthService. Use environment flag to switch between mock and real service</rule>
      <rule>Redux state management: Create authSlice in mobile/src/store/auth/ and web/src/store/auth/ following Redux Toolkit patterns (createAsyncThunk for API calls, createSlice for reducers)</rule>
      <rule>Path aliases: Use @shared/ import alias for shared library imports (configured in tsconfig). Use @mobile/ and @web/ for platform-specific imports</rule>
      <rule>TypeScript strict mode enabled - use proper typing for ALL API calls, Redux actions, and component props. No 'any' types allowed except for legitimate dynamic content</rule>
      <rule>Error handling pattern: Map API errors to user-friendly messages using ApiError type. Create error message map for common error codes (401, 404, 409, 500)</rule>
      <rule>Form validation: Implement real-time validation with debounce (300ms delay) to prevent excessive validation calls while user is typing</rule>
    </architecture>
    <performance>
      <rule>Authentication flow completion target: &lt;2 seconds from form submission to success screen per NFR requirement</rule>
      <rule>Token refresh must be transparent: Background token refresh &lt;500ms, no UI blocking or loading indicators during refresh</rule>
      <rule>Form validation must be instant: Real-time validation feedback &lt;50ms after user input with debounce for network-based checks</rule>
      <rule>Bundle size monitoring: Mobile app &lt;50MB total, web app initial bundle &lt;2MB. Use code splitting for auth flows if needed</rule>
      <rule>Memory usage: Mobile authentication flows must stay &lt;150MB during normal operation (registration, login, password reset)</rule>
      <rule>Optimize image assets: Password strength indicator graphics &lt;10KB, use vector icons where possible to reduce bundle size</rule>
    </performance>
    <testing>
      <rule>Unit test coverage: ≥90% for service layer (auth.service.ts, validation.ts, storage.ts), ≥80% for components (screens, pages, forms)</rule>
      <rule>Integration test coverage: ALL API endpoints and authentication flows (register, login, forgot password, reset password) must have integration tests with mock API</rule>
      <rule>E2E test coverage: Critical user journeys (register → login → dashboard, forgot password complete flow) must have E2E tests on both mobile and web</rule>
      <rule>Testing strategy: Write unit tests alongside implementation, integration tests after feature complete, E2E tests for final validation</rule>
      <rule>Mock data consistency: Use predefined test users and scenarios across all test types for reproducible results</rule>
      <rule>Performance testing: Validate authentication flow timing (&lt;2s) and memory usage (&lt;150MB) as part of E2E test suite</rule>
    </testing>
  </constraints>

  <interfaces>
    <interface name="IAuthService.register()" kind="service-method">
      <signature>register(userData: RegisterRequest): Promise&lt;AuthResponse&gt;</signature>
      <path>shared/src/services/api/auth.service.ts</path>
      <description>Authentication service method for user registration. Accepts RegisterRequest with email, password, displayName, homeCity. Returns AuthResponse with User object and AuthTokens. Throws ApiError on validation failures (400), duplicate email (409), or server errors (500).</description>
    </interface>
    <interface name="IAuthService.login()" kind="service-method">
      <signature>login(credentials: LoginRequest): Promise&lt;AuthResponse&gt;</signature>
      <path>shared/src/services/api/auth.service.ts</path>
      <description>Authentication service method for email/password login. Accepts LoginRequest with email and password. Returns AuthResponse with User and tokens. Handles "remember me" flag via extended token expiration (90 days vs 7 days).</description>
    </interface>
    <interface name="IAuthService.forgotPassword()" kind="service-method">
      <signature>forgotPassword(email: string): Promise&lt;void&gt;</signature>
      <path>shared/src/services/api/auth.service.ts</path>
      <description>Initiates password reset flow by sending reset email. Accepts email address string. Returns void on success. Backend sends email with time-limited reset token (1 hour expiration).</description>
    </interface>
    <interface name="IAuthService.resetPassword()" kind="service-method">
      <signature>resetPassword(token: string, newPassword: string): Promise&lt;void&gt;</signature>
      <path>shared/src/services/api/auth.service.ts</path>
      <description>Completes password reset flow. Accepts reset token (from email link) and new password. Returns void on success. Validates token expiration and single-use constraint on backend. Throws ApiError if token expired or invalid.</description>
    </interface>
    <interface name="POST /api/auth/register" kind="rest-endpoint">
      <signature>POST /api/auth/register { email, password, displayName, homeCity }</signature>
      <path>Backend API (separate repository)</path>
      <description>Backend registration endpoint. Request body matches RegisterRequest interface. Returns 201 Created with AuthResponse (user + tokens) on success. Returns 400 for validation errors, 409 for duplicate email, 500 for server errors.</description>
    </interface>
    <interface name="POST /api/auth/login" kind="rest-endpoint">
      <signature>POST /api/auth/login { email, password, rememberMe? }</signature>
      <path>Backend API (separate repository)</path>
      <description>Backend login endpoint. Request body matches LoginRequest with optional rememberMe boolean. Returns 200 OK with AuthResponse on success. Returns 401 for invalid credentials, 404 for user not found, 500 for server errors.</description>
    </interface>
    <interface name="POST /api/auth/forgot-password" kind="rest-endpoint">
      <signature>POST /api/auth/forgot-password { email }</signature>
      <path>Backend API (separate repository)</path>
      <description>Backend forgot password endpoint. Request body contains email string. Returns 200 OK on success (sends email with reset link). Returns 404 if email not found, 500 for server errors. Does not reveal whether email exists for security.</description>
    </interface>
    <interface name="POST /api/auth/reset-password" kind="rest-endpoint">
      <signature>POST /api/auth/reset-password { token, newPassword }</signature>
      <path>Backend API (separate repository)</path>
      <description>Backend reset password endpoint. Request body contains reset token (from email) and new password. Returns 200 OK on success. Returns 400 for expired/invalid token, 400 for weak password, 500 for server errors.</description>
    </interface>
    <interface name="SecureStorageService" kind="platform-abstraction">
      <signature>storeTokens(tokens: AuthTokens), getTokens(): Promise&lt;AuthTokens|null&gt;, clearTokens()</signature>
      <path>shared/src/services/storage/secureStorage.ts</path>
      <description>Cross-platform secure storage abstraction for JWT token persistence. Mobile uses React Native Keychain (iOS) and Android Keystore (Android). Web uses encrypted browser storage. Provides async methods for storing, retrieving, and clearing authentication tokens.</description>
    </interface>
    <interface name="validateEmail / validatePassword" kind="validation-utility">
      <signature>validateEmail(email: string): boolean, validatePassword(password: string): { valid: boolean, strength: 'weak'|'medium'|'strong' }</signature>
      <path>shared/src/utils/validation.ts</path>
      <description>Client-side validation utilities for form inputs. validateEmail uses regex for email format. validatePassword checks min 8 chars, 1 uppercase, 1 number, 1 special char and returns strength rating. Used for real-time form feedback.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit testing with Jest + React Testing Library for service layer and components. Integration testing with mock API responses for complete authentication flows. E2E testing using Detox (mobile) and Playwright (web) for critical user journeys. Test pyramid approach: 70% unit tests, 20% integration tests, 10% E2E tests. Code coverage targets: ≥90% for services, ≥80% for components. All tests must pass in CI/CD pipeline before merge. Performance validation included in E2E tests (authentication flow &lt;2s, memory usage &lt;150MB).
    </standards>
    <locations>
      <pattern>shared/src/__tests__/*.test.ts</pattern>
      <pattern>mobile/src/__tests__/**/*.test.tsx</pattern>
      <pattern>web/src/__tests__/**/*.test.tsx</pattern>
      <pattern>mobile/e2e/**/*.e2e.ts</pattern>
      <pattern>web/e2e/**/*.spec.ts</pattern>
    </locations>
    <ideas>
      <idea ac="AC1">Unit test: validateEmail function with valid/invalid email formats (missing @, multiple @, invalid domain). Unit test: validatePassword function with various password strengths (weak: only lowercase, medium: mixed case + number, strong: all requirements met). Integration test: Registration flow with mock API returning 201 success, validate token storage and navigation to dashboard. Integration test: Registration with duplicate email (409 error), verify error message display. E2E test: Complete registration flow on mobile (iOS + Android) and web, verify user can login after registration.</idea>
      <idea ac="AC2">Unit test: Login form validation prevents empty submission, validates email format. Integration test: Login flow with mock API returning 200 success, validate token storage with correct expiration. Integration test: Login with invalid credentials (401 error), verify error message "Invalid email or password". Integration test: Login with non-existent user (404 error), verify generic error message for security. E2E test: Login → Dashboard navigation on all platforms, verify persistent session after app restart.</idea>
      <idea ac="AC3">Unit test: "Remember me" extends token expiration to 90 days vs default 7 days. Integration test: Login with rememberMe=true, verify stored tokens have extended expiration. Integration test: Login with rememberMe=false, verify default expiration used. E2E test: Login with "Remember me" enabled, restart app, verify user still logged in after 8 days (beyond default 7-day expiration).</idea>
      <idea ac="AC4">Unit test: Password reset email validation prevents submission with invalid email. Integration test: Forgot password flow with mock API returning 200, verify success message displayed. Integration test: Reset password with valid token, verify success and redirect to login. Integration test: Reset password with expired token, verify error message "Reset link expired". E2E test: Complete forgot password flow including email link navigation (simulated deep link), reset password, login with new password.</idea>
      <idea ac="ALL">Performance test: Measure registration flow timing from form submit to dashboard (target &lt;2s). Performance test: Measure login flow timing with various network conditions (3G, 4G, WiFi). Security test: Verify tokens stored in Keychain/Keystore (mobile) not accessible via device debugging tools. Security test: Attempt password reset with tampered token, verify rejection. Accessibility test: Verify screen reader announces form errors, keyboard navigation works for all forms.</idea>
    </ideas>
  </tests>
</story-context>
