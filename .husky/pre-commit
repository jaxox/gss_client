#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run lint-staged for code formatting and linting
npx lint-staged

# Run type checking on all packages
npm run type-check

# Run tests in CI mode
npm run test:ci

# E2E tests - Only run if SKIP_E2E is not set
# To skip: SKIP_E2E=1 git commit -m "message"
# To run: git commit -m "message" (default behavior)
if [ -z "$SKIP_E2E" ]; then
  echo "ğŸ§ª Running E2E tests (use SKIP_E2E=1 to skip)..."
  
  # Check if Metro is already running
  if ! lsof -ti:8081 > /dev/null 2>&1; then
    echo "âš ï¸  Metro bundler not running on port 8081"
    echo "Please start Metro in another terminal: cd mobile && npm start"
    echo "Or skip E2E tests: SKIP_E2E=1 git commit -m \"message\""
    exit 1
  fi
  
  # Build app if binary doesn't exist
  if [ ! -d "mobile/ios/build/Build/Products/Debug-iphonesimulator/GSS_Mobile.app" ]; then
    echo "ğŸ“± Building iOS app for E2E tests..."
    cd mobile && npm run test:e2e:build:ios || exit 1
    cd ..
  fi
  
  # Run E2E tests
  echo "ğŸ§ª Running iOS E2E tests..."
  cd mobile && npm run test:e2e:ios:debug || exit 1
  cd ..
else
  echo "â­ï¸  Skipping E2E tests (SKIP_E2E is set)"
fi